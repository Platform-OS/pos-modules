---
name: generic
to: "{{ data.to }}"
request_type: "{{ data.request_type }}"
callback: >
  {% liquid
    assign response_data = response.body | to_hash
    if response_data.error
      assign type = 'ERROR stripe api callback to ' | append: data.to
      log response_data.error, type: type
    endif
  %}
request_headers: >
  {% assign stripe_account_name = data.stripe_account_name | default: data.payload.stripe_account_name %}
  {% if stripe_account_name != blank %}
    {% assign stripe_key_name = 'stripe_sk_key' | append: '_' | append: stripe_account_name %}
  {% else %}
    {% assign stripe_key_name = 'stripe_sk_key' %}
  {% endif %}
  {%- function stripe_sk_key = 'modules/core/lib/queries/variable/find', name: stripe_key_name -%}
  {
    {%- if data.idempotency_key or data.payload.idempotency_key -%}
      "Idempotency-Key": "{{ data.payload.idempotency_key | default: data.idempotency_key }}",
    {%- endif -%}
    {%- if data.payload -%}
      "Content-Type": "application/x-www-form-urlencoded",
    {%- endif -%}
    {%- if data.payload.connected_account_id -%}
      "Stripe-Account": "{{ data.payload.connected_account_id }}",
    {%- endif -%}
    "Authorization": "Bearer {{ stripe_sk_key }}"
  }
---
{% liquid
  assign _ = data.payload | hash_delete_key: 'connected_account_id'
  assign _ = data.payload | hash_delete_key: 'idempotency_key'
  assign _ = data.payload | hash_delete_key: 'stripe_account_name'

  if data.payload
    assign encoded = data.payload | www_form_encode_rc
    echo encoded
  endif
%}
