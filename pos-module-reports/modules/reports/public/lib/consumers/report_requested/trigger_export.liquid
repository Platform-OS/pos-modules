{% liquid
  graphql g = 'modules/reports/reports/search', id: object_id
  assign operation = g.reports.results.first
  function res = 'modules/core/commands/statuses/create', name: 'modules/reports/statuses.report.started', reference_id: operation.id, requester_id: 'report'

  function results = operation.retrieve_all_command
  if operation.file_name
    assign file_name = operation.file_name
  else
    assign file_name = "export.csv"
  endif
  assign content_disposition = "attachment; filename=" | append: file_name | append: ";"

  assign object_payload = '{}' | parse_json | hash_merge: content: results, object_uuid: operation.uuid, document_type: 'file', content_type: "text/csv; charset=UTF-8", content_disposition: content_disposition
  function document = 'modules/reports/commands/documents/create_with_content', object: object_payload, creator_id: operation.creator_id
  if document.valid
    function res = 'modules/core/commands/statuses/create', name: 'modules/reports/statuses.report.done', reference_id: operation.id, requester_id: 'report'
    assign object_payload = '{}' | parse_json | hash_merge: creator_id: operation.creator_id, user_id: operation.user_id, object_id: operation.id, document_id: document.id, app_host: event.app_host
    function _event = 'modules/core/commands/events/publish', type: 'report_completed', object: object_payload
  else
    log document, type: 'ERROR: trigger_export document'
    function res = 'modules/core/commands/statuses/create', name: 'modules/reports/statuses.report.error', reference_id: operation.id, requester_id: 'report'
  endif
%}
